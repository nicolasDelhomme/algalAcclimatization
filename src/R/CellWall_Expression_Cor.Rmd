 ---
 title: "Algae time series Expression and Cell Wall thickness correlation"
 subtitle: "projectID: u2019005"
 author: "Aman Zare & Nicolas Delhomme"
 date: "`r Sys.Date()`"
 output: 
  html_document:
   fig_width: 9
   fig_height: 6
   toc: TRUE
   number_sections: TRUE
   toc_depth: 3
   toc_float:
    collapsed: TRUE
    smooth_scroll: TRUE
   code_folding: hide
   theme: "flatly" 
   highlight: pygments
   includes:
    before_body: header.html
    after_body: footer.html
   css: style.css    
 ---
 
```{r set up}
suppressPackageStartupMessages({
  library(here)
  library(tidyverse)
})
```

We use a combination of the Sequence Description and Gene Ontology (GO) term to fetch cell wall related gene candidates
```{r cell wall genes}
# Annotation
annotation <- read_tsv(here("data/b2g/blast2go_20190117_export.txt.gz"),show_col_types=FALSE) %>% 
  mutate(`Sequence Name`=sub("\\.p\\d+$","",`Sequence Name`))

# GO dictionary
go_annot <- annotation %>% select(`Annotation GO ID`,`Annotation GO Term`,`Annotation GO Category`) %>% 
  rename(ID=`Annotation GO ID`,Term=`Annotation GO Term`,Category=`Annotation GO Category`) %>% 
  filter(!is.na(ID)) 

go_annot <- tibble(ID=unlist(str_split(go_annot$ID,"\\|"),use.names=FALSE),
                   Term=unlist(str_split(go_annot$Term,"\\|"),use.names=FALSE),
                   Category=unlist(str_split(go_annot$Category,"\\|"),use.names=FALSE)) %>% distinct()
# Expression
expression <- read_tsv(here("data/analysis/salmon/variance-stabilised_model-aware_gene-expression_data.tsv"),
                       show_col_types=FALSE)
# Reverse sample swap
expression %<>% rename(B2_2_24hrs_D="B2_2_12hrs_D",B2_2_12hrs_D="B2_2_24hrs_D")

# Gene of interest
goi <- unlist(annotation[grepl("cell wall",annotation$`Sequence Description`) | 
  grepl("cell wall",annotation$`Annotation GO Term`),"Sequence Name"],use.names=FALSE)

#' replace (\\.p\\d+$) .p followed by any number of digits. The $ the sign that indicates the end of the text
goi <- sub("\\.p\\d+$","",goi)

#' sanity
stopifnot(length(goi)==length(unique(goi)))

message(sprintf("There are %s candidates",length(goi)))

#' * samples information
samples <-read_tsv(here("doc/Samples-swap-corrected.tsv"),show_col_types = FALSE)

#' ## Expression
vst <- expression %>% filter(rowname %in% goi) %>% column_to_rownames() %>% as.matrix()
sel <- rowSums(vst) > 0
vst <- vst[sel,]

samples <- samples[match(colnames(vst),samples$SampleID),]

#' * Export
write_tsv(vst %>% as_tibble() %>% rownames_to_column("ID"),
          here("data/analysis/cell-wall/goi-vst-expression_with-geneID.tsv"))
```

```{r preparing matrices for cor}
#cell wall
cw <- read_tsv(here("doc/Cell-wall-measurement.tsv"))
cw %<>% filter(treatment %in% "control", !time_in_hours %in% c(48,240))

colnames(vst) %<>% gsub(pattern = "B2_2_", replacement = "")
colnames(vst) %<>%  gsub(pattern = "60min", replacement = "1hrs_")
vst %<>% as.data.frame()
vst$gene <- rownames(vst)

#calculating the average expression of reps
vst_avg <- vst %>% pivot_longer(cols = -gene, names_to = c("time", "rep"), names_sep = "_") %>%
   group_by(time, gene) %>% 
   summarize(meanExp = mean(value)) %>% 
   pivot_wider(names_from = time, values_from = meanExp)

#reorder the columns based on the cw data
vst_avg <- vst_avg[, c(1, match(paste0(cw$time_in_hours, "hrs"), colnames(vst_avg)))]

#correlation
vst_avg %<>% 
   rowwise() %>% 
   mutate(width_Cor = cor(c_across(`1hrs`:`120hrs`),
                          cw$width_in_um %>% as.vector(),
                          method = "pearson"))

vst_avg$width_Cor %>% hist()

```

```{r cor plots}
hist(vst_avg$width_Cor)
heatmap.2(t(scale(t(vst_avg[,-1]))),
          distfun=pearson.dist,
          hclustfun=function(X){hclust(X,method="ward.D2")},
          labRow = NA,trace = "none",
          col=hpal, Colv = FALSE, dendrogram = "row")
vst_avg %>% ggplot(aes(x = "Correlation values", y = width_Cor)) + geom_violin() + geom_jitter()
```

